<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>منصة الأستاذ محمد درويش التعليمية</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Cairo', sans-serif;
            transition: background-color 0.3s, color 0.3s;
        }
        .dark {
            --tw-bg-opacity: 1;
            background-color: rgb(17 24 39 / var(--tw-bg-opacity)); /* bg-gray-900 */
            color: rgb(209 213 219 / var(--tw-bg-opacity)); /* text-gray-300 */
        }
        .dark .bg-white {
            --tw-bg-opacity: 1;
            background-color: rgb(31 41 55 / var(--tw-bg-opacity)); /* bg-gray-800 */
        }
        .dark .text-gray-800 {
            color: rgb(229 231 235 / var(--tw-bg-opacity)); /* text-gray-200 */
        }
        .dark .text-gray-600, .dark .text-gray-500 {
            color: rgb(156 163 175 / var(--tw-bg-opacity)); /* text-gray-400 */
        }
        .dark .border-gray-300 {
            border-color: rgb(75 85 99 / var(--tw-bg-opacity)); /* border-gray-600 */
        }
        .dark .hover\:bg-gray-100:hover {
            --tw-bg-opacity: 1;
            background-color: rgb(55 65 81 / var(--tw-bg-opacity)); /* hover:bg-gray-700 */
        }
        .dark input, .dark select, .dark textarea {
            background-color: rgb(55 65 81 / var(--tw-bg-opacity)); /* bg-gray-700 */
            color: rgb(229 231 235 / var(--tw-bg-opacity)); /* text-gray-200 */
            border-color: rgb(75 85 99 / var(--tw-bg-opacity)); /* border-gray-600 */
        }
        .dark button.bg-blue-600 { background-color: rgb(37 99 235); }
        .dark button.bg-blue-600:hover { background-color: rgb(29 78 216); }
        .dark button.bg-green-500 { background-color: rgb(34 197 94); }
        .dark button.bg-green-500:hover { background-color: rgb(22 163 74); }
        .dark button.bg-red-500 { background-color: rgb(239 68 68); }
        .dark button.bg-red-500:hover { background-color: rgb(220 38 38); }
        .dark button.bg-yellow-500 { background-color: rgb(234 179 8); }
        .dark button.bg-yellow-500:hover { background-color: rgb(202 138 4); }
        .dark .bg-gray-50 { background-color: rgb(55 65 81 / 0.7); } /* Adjusted for cards in dark mode */
        .dark .bg-gray-200 { background-color: rgb(55 65 81); } /* bg-gray-700 for table head */


        .hidden { display: none !important; } /* Use !important to ensure override if needed during transitions */
        
        /* Modal Base Styles */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.6); display: flex;
            justify-content: center; align-items: center; z-index: 1000;
            transition: opacity 0.3s ease-out, visibility 0.3s ease-out;
            opacity: 0;
            visibility: hidden;
        }
        .modal:not(.hidden) { /* When modal is to be shown */
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            min-width: 300px; max-width: 90%;
            transition: transform 0.3s ease-out;
            transform: scale(0.95) translateY(10px);
        }
        .modal:not(.hidden) .modal-content {
             transform: scale(1) translateY(0);
        }


        /* Page and Section Transitions */
        .page-container, .admin-section, .student-section {
            transition: opacity 0.4s ease-out, transform 0.4s ease-out;
        }
        .page-container.hidden, .admin-section.hidden, .student-section.hidden {
            opacity: 0;
            transform: translateY(15px);
            pointer-events: none;
        }
         /* Visible state is implicitly opacity:1, transform:translateY(0) */


        /* Enhanced Button Styles */
        .btn {
            padding: 0.6rem 1.2rem;
            border-radius: 9999px; /* Pill shape */
            font-weight: 600;
            text-align: center;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border: none;
            cursor: pointer;
        }
        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        .btn:active {
            transform: translateY(0px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .btn-primary { background-color: #2563EB; color: white; } /* blue-600 */
        .btn-primary:hover { background-color: #1D4ED8; } /* blue-700 */
        .btn-secondary { background-color: #4B5563; color: white; } /* gray-700 */
        .btn-secondary:hover { background-color: #374151; } /* gray-800 */
        .btn-success { background-color: #10B981; color: white; } /* green-500 */
        .btn-success:hover { background-color: #059669; } /* green-600 */
        .btn-danger { background-color: #EF4444; color: white; } /* red-500 */
        .btn-danger:hover { background-color: #DC2626; } /* red-600 */
        .btn-warning { background-color: #F59E0B; color: white; } /* amber-500 */
        .btn-warning:hover { background-color: #D97706; } /* amber-600 */
        
        .btn-icon {
            padding: 0.5rem;
            width: 2.5rem; /* 40px */
            height: 2.5rem; /* 40px */
            border-radius: 50%;
            display: inline-flex;
            justify-content: center;
            align-items: center;
        }
        .btn-icon svg { width: 1.25rem; height: 1.25rem; } /* 20px */

        /* Table Action Buttons */
        .btn-action-table {
            padding: 0.3rem 0.8rem; /* Adjusted padding */
            border-radius: 0.375rem; /* rounded-md */
            font-size: 0.875rem; /* text-sm */
            font-weight: 600;
            text-align: center;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            border: 1px solid transparent;
            margin: 0 0.125rem; /* Added small margin */
        }
        .btn-action-table:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
        }
        .btn-action-table.edit {
            background-color: #EFF6FF; color: #3B82F6; border-color: #BFDBFE;
        }
        .btn-action-table.edit:hover { background-color: #DBEAFE; color: #2563EB; }
        .dark .btn-action-table.edit { background-color: rgba(59, 130, 246, 0.2); color: #93C5FD; border-color: rgba(59, 130, 246, 0.4); }
        .dark .btn-action-table.edit:hover { background-color: rgba(59, 130, 246, 0.3); color: #BFDBFE; }

        .btn-action-table.delete {
            background-color: #FEF2F2; color: #EF4444; border-color: #FECACA;
        }
        .btn-action-table.delete:hover { background-color: #FEE2E2; color: #DC2626; }
        .dark .btn-action-table.delete { background-color: rgba(239, 68, 68, 0.2); color: #F87171; border-color: rgba(239, 68, 68, 0.4); }
        .dark .btn-action-table.delete:hover { background-color: rgba(239, 68, 68, 0.3); color: #FCA5A5; }
        
        .btn-action-table.preview {
            background-color: #F0FDF4; color: #22C55E; border-color: #BBF7D0;
        }
        .btn-action-table.preview:hover { background-color: #DCFCE7; color: #16A34A; }
        .dark .btn-action-table.preview { background-color: rgba(34, 197, 94, 0.2); color: #4ADE80; border-color: rgba(34, 197, 94, 0.4); }
        .dark .btn-action-table.preview:hover { background-color: rgba(34, 197, 94, 0.3); color: #86EFAC; }


        /* Profile Picture Styles */
        .profile-pic-container {
            position: relative; width: 120px; height: 120px; border-radius: 50%;
            background-color: #E5E7EB; margin: 1rem auto; cursor: pointer;
            overflow: hidden; border: 3px solid white; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .dark .profile-pic-container { background-color: #4B5563; border-color: #374151; }
        #profileImagePreview { width: 100%; height: 100%; object-fit: cover; }
        .profile-pic-edit-icon {
            position: absolute; bottom: 5px; right: 5px; background-color: rgba(0,0,0,0.6);
            color: white; border-radius: 50%; padding: 6px; display: flex;
            align-items: center; justify-content: center; transition: background-color 0.2s;
        }
        .profile-pic-edit-icon:hover { background-color: rgba(0,0,0,0.8); }
        .profile-pic-edit-icon svg { width: 16px; height: 16px; }
        #deleteProfilePicBtn {
            position: absolute; top: 5px; right: 5px; background-color: rgba(239, 68, 68, 0.7);
            color: white; border-radius: 50%; padding: 4px; width: 24px; height: 24px;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
            transition: background-color 0.2s; z-index: 10;
        }
        #deleteProfilePicBtn:hover { background-color: rgba(220, 38, 38, 1); }
        #deleteProfilePicBtn svg { width: 14px; height: 14px; }

        /* Chatbot Styles */
        .chatbot-icon {
            position: fixed; bottom: 20px; left: 20px;
            background-color: #1D4ED8; color: white; width: 60px; height: 60px; border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.25); z-index: 999;
            transition: transform 0.2s ease-in-out, background-color 0.2s;
        }
        .chatbot-icon:hover { transform: scale(1.1); background-color: #2563EB; }
        .chatbot-icon svg { width: 30px; height: 30px; }

        .chatbot-window {
            position: fixed; bottom: 90px; left: 20px;
            width: 350px; height: 450px; background-color: white;
            border-radius: 15px; box-shadow: 0 8px 25px rgba(0,0,0,0.2);
            display: flex; flex-direction: column; overflow: hidden; z-index: 998;
            transition: opacity 0.3s ease-out, transform 0.3s ease-out, visibility 0.3s ease-out;
            opacity: 0; transform: translateY(20px) scale(0.95); visibility: hidden;
        }
         .chatbot-window:not(.hidden) { /* When chatbot window is to be shown */
            opacity: 1;
            transform: translateY(0) scale(1);
            visibility: visible;
        }
        .dark .chatbot-window { background-color: rgb(31 41 55); }
        .chatbot-header {
            background: linear-gradient(135deg, #2563EB, #1D4ED8);
            color: white; padding: 12px 15px; text-align: center; font-weight: bold;
            border-top-left-radius: 15px; border-top-right-radius: 15px;
        }
        .chatbot-messages {
            flex-grow: 1; padding: 15px; overflow-y: auto; display: flex;
            flex-direction: column; gap: 10px;
        }
        .chatbot-input {
            display: flex; padding: 10px; border-top: 1px solid #E5E7EB;
            background-color: #F9FAFB;
        }
        .dark .chatbot-input { border-top-color: rgb(55 65 81); background-color: rgb(55 65 81); }
        .chatbot-input input {
            flex-grow: 1; padding: 10px; border: 1px solid #D1D5DB;
            border-radius: 20px; margin-left: 8px; outline: none;
        }
        .dark .chatbot-input input { background-color: rgb(75 85 99); border-color: rgb(75 85 99); color: white; }
        .chatbot-input button {
            padding: 10px 15px; background-color: #1D4ED8;
            color: white; border: none; border-radius: 20px; cursor: pointer;
            font-weight: 600; transition: background-color 0.2s;
        }
        .chatbot-input button:hover { background-color: #2563EB; }

        .message { padding: 10px 15px; border-radius: 18px; max-width: 75%; word-wrap: break-word; line-height: 1.4; }
        .user-message {
            background-color: #DBEAFE; color: #1E3A8A;
            align-self: flex-end; border-bottom-right-radius: 5px;
        }
        .dark .user-message { background-color: #3B82F6; color: white; }
        .bot-message {
            background-color: #E5E7EB; color: #374151;
            align-self: flex-start; border-bottom-left-radius: 5px;
        }
        .dark .bot-message { background-color: rgb(55 65 81); color: rgb(209 213 219); }
        
        .message-enter {
            opacity: 0;
            transform: translateY(10px);
            animation: messageEnterAnimation 0.3s ease-out forwards;
        }
        @keyframes messageEnterAnimation {
            to { opacity: 1; transform: translateY(0); }
        }

        /* Nav Link Styles */
        .admin-nav-link, .student-nav-link {
            padding: 0.6rem 1rem; /* Increased padding slightly */
            border-radius: 8px;
            transition: background-color 0.2s, color 0.2s, border-color 0.2s, font-weight 0.2s;
            border-bottom-width: 3px; /* Base border width */
        }
        /* Active Nav Link Style */
        .admin-nav-link.admin-nav-active {
            font-weight: 700; /* bolder */
            color: #1D4ED8 !important; /* blue-700 */
            border-color: #2563EB !important; /* blue-600 */
            background-color: rgba(59, 130, 246, 0.1); 
        }
        .dark .admin-nav-link.admin-nav-active {
            color: #60A5FA !important; /* blue-400 */
            border-color: #3B82F6 !important; /* blue-500 */
            background-color: rgba(59, 130, 246, 0.2);
        }
        .student-nav-link.student-nav-active {
            font-weight: 700;
            color: #059669 !important; /* green-600 */
            border-color: #10B981 !important; /* green-500 */
            background-color: rgba(16, 185, 129, 0.1);
        }
        .dark .student-nav-link.student-nav-active {
            color: #34D399 !important; /* green-400 */
            border-color: #10B981 !important; /* green-500 */
            background-color: rgba(16, 185, 129, 0.2);
        }

        /* Dark Mode Toggle Button Styling */
        #darkModeToggle {
            background-color: #F9FAFB; /* gray-50 */
            color: #374151; /* gray-700 */
            border: 1px solid #D1D5DB; /* gray-300 */
        }
        #darkModeToggle:hover {
            background-color: #F3F4F6; /* gray-100 */
        }
        .dark #darkModeToggle {
            background-color: #374151; /* gray-700 */
            color: #F3F4F6; /* gray-100 */
            border: 1px solid #4B5563; /* gray-600 */
        }
        .dark #darkModeToggle:hover {
            background-color: #4B5563; /* gray-600 */
        }

    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <button id="darkModeToggle" class="btn btn-icon fixed top-4 left-4 z-50">
        </button>

    <div id="appContainer" class="container mx-auto p-4 min-h-screen">

        <div id="loginPage" class="page-container max-w-md mx-auto mt-10 bg-white p-8 rounded-lg shadow-xl">
            <h1 class="text-3xl font-bold text-center text-blue-600 mb-2">منصة الأستاذ محمد درويش</h1>
            
            <div class="mt-6 mb-8 text-center">
                <div id="profilePicContainer" class="profile-pic-container">
                    <img id="profileImagePreview" src="https://placehold.co/120x120/E5E7EB/4B5563?text=صورتي" alt="صورة الأستاذ">
                    <input type="file" id="profileImageInput" class="hidden" accept="image/*">
                    <div id="editProfilePicBtn" class="profile-pic-edit-icon" title="تغيير الصورة">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" />
                        </svg>
                    </div>
                    <button id="deleteProfilePicBtn" class="hidden" title="حذف الصورة">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
            </div>

            <h2 class="text-2xl font-semibold text-center mb-6">تسجيل الدخول</h2>
            <form id="loginForm">
                <div class="mb-4">
                    <label for="username" class="block text-sm font-medium text-gray-700 mb-1">اسم المستخدم</label>
                    <input type="text" id="username" name="username" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-sm font-medium text-gray-700 mb-1">كلمة المرور</label>
                    <input type="password" id="password" name="password" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
                <button type="submit" class="w-full btn btn-primary">
                    دخول
                </button>
                <p id="loginError" class="text-red-500 text-sm mt-2 text-center"></p>
                <p class="text-center mt-4 text-sm text-gray-600">
                    ليس لديك حساب؟ <a href="#" id="showRegisterLink" class="text-blue-600 hover:underline">سجل كطالب</a>
                </p>
            </form>
        </div>

        <div id="registrationPage" class="page-container hidden max-w-md mx-auto mt-10 bg-white p-8 rounded-lg shadow-xl">
            <h2 class="text-2xl font-semibold text-center mb-6">تسجيل طالب جديد</h2>
            <form id="registrationForm">
                <div class="mb-4">
                    <label for="regName" class="block text-sm font-medium text-gray-700 mb-1">الاسم الكامل</label>
                    <input type="text" id="regName" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="mb-4">
                    <label for="regUsername" class="block text-sm font-medium text-gray-700 mb-1">اسم المستخدم (للدخول)</label>
                    <input type="text" id="regUsername" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="mb-4">
                    <label for="regPassword" class="block text-sm font-medium text-gray-700 mb-1">كلمة المرور</label>
                    <input type="password" id="regPassword" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
                <button type="submit" class="w-full btn btn-success">
                    تسجيل
                </button>
                <p id="registerError" class="text-red-500 text-sm mt-2 text-center"></p>
                <p class="text-center mt-4 text-sm text-gray-600">
                    لديك حساب بالفعل؟ <a href="#" id="showLoginLinkFromRegister" class="text-blue-600 hover:underline">سجل الدخول</a>
                </p>
            </form>
        </div>
        
        <div id="adminDashboardPage" class="page-container hidden">
            <header class="bg-white shadow-md rounded-lg p-6 mb-8">
                <div class="flex flex-wrap justify-between items-center gap-4">
                    <h1 class="text-3xl font-bold text-blue-700">لوحة تحكم الأستاذ</h1>
                    <button id="adminLogoutBtn" class="btn btn-danger">تسجيل الخروج</button>
                </div>
                <nav class="mt-4">
                    <ul class="flex flex-wrap gap-x-2 sm:gap-x-4 border-b border-gray-300 dark:border-gray-600 pb-1">
                        <li><button data-target="adminStudentsSection" class="admin-nav-link font-semibold text-gray-600 hover:text-blue-600 border-transparent hover:border-blue-500">إدارة الطلاب</button></li>
                        <li><button data-target="adminContentSection" class="admin-nav-link font-semibold text-gray-600 hover:text-blue-600 border-transparent hover:border-blue-500">إدارة المحتوى</button></li>
                        <li><button data-target="adminExamsSection" class="admin-nav-link font-semibold text-gray-600 hover:text-blue-600 border-transparent hover:border-blue-500">إنشاء الاختبارات</button></li>
                        <li><button data-target="adminProfileSection" class="admin-nav-link font-semibold text-gray-600 hover:text-blue-600 border-transparent hover:border-blue-500">ملف الأستاذ</button></li>
                    </ul>
                </nav>
            </header>

            <div id="adminStudentsSection" class="admin-section bg-white p-6 rounded-lg shadow-lg">
                <h2 class="text-2xl font-semibold mb-6 text-blue-700">إدارة الطلاب</h2>
                <button id="showAddStudentModalBtn" class="mb-6 btn btn-success">إضافة طالب جديد</button>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white border border-gray-300 rounded-lg">
                        <thead class="bg-gray-200">
                            <tr>
                                <th class="py-3 px-4 border-b text-right font-semibold text-gray-700">الاسم</th>
                                <th class="py-3 px-4 border-b text-right font-semibold text-gray-700">اسم المستخدم</th>
                                <th class="py-3 px-4 border-b text-right font-semibold text-gray-700">الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="studentsTableBody">
                            </tbody>
                    </table>
                </div>
            </div>

            <div id="adminContentSection" class="admin-section hidden bg-white p-6 rounded-lg shadow-lg">
                <h2 class="text-2xl font-semibold mb-6 text-blue-700">إدارة المحتوى التعليمي</h2>
                <button id="showAddContentModalBtn" class="mb-6 btn btn-success">إضافة محتوى جديد</button>
                <div id="contentList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    </div>
            </div>

            <div id="adminExamsSection" class="admin-section hidden bg-white p-6 rounded-lg shadow-lg">
                <h2 class="text-2xl font-semibold mb-6 text-blue-700">إنشاء و إدارة الاختبارات</h2>
                <button id="showCreateExamModalBtn" class="mb-6 btn btn-success">إنشاء اختبار جديد</button>
                <p class="text-sm text-gray-500 mb-4">ملاحظة: إنشاء الأسئلة من الملفات مباشرة وتصحيح المقالي تلقائياً هي ميزات متقدمة. حالياً، يمكنك إدخال الأسئلة يدوياً.</p>
                <div id="examsList" class="space-y-4">
                    </div>
            </div>
            
            <div id="adminProfileSection" class="admin-section hidden bg-white p-6 rounded-lg shadow-lg">
                <h2 class="text-2xl font-semibold mb-6 text-blue-700">عن الأستاذ محمد درويش</h2>
                <div class="space-y-4 text-lg">
                    <p><strong class="font-semibold">الاسم:</strong> الأستاذ محمد درويش</p>
                    <p><strong class="font-semibold">اللقب:</strong> كبير معلمى اللغة العربية بإدارة شرق بمحافظة الإسكندرية</p>
                    <p><strong class="font-semibold">المدرسة:</strong> الأستاذ المشرف على المادة بالقسم الاعدادي بمدرسة اشرف الخوجة لغات</p>
                    <p><strong class="font-semibold">أرقام التواصل:</strong></p>
                    <ul class="list-disc list-inside mr-4">
                        <li>01223323049</li>
                        <li>01223338507</li>
                    </ul>
                    <p><strong class="font-semibold">فيسبوك:</strong> <a href="https://www.facebook.com/share/16BudhEXqm/" target="_blank" class="text-blue-500 hover:underline">صفحة الأستاذ محمد درويش</a></p>
                </div>
            </div>
        </div>

        <div id="studentDashboardPage" class="page-container hidden">
            <header class="bg-white shadow-md rounded-lg p-6 mb-8">
                <div class="flex flex-wrap justify-between items-center gap-4">
                    <h1 class="text-3xl font-bold text-green-700">لوحة تحكم الطالب</h1>
                    <button id="studentLogoutBtn" class="btn btn-danger">تسجيل الخروج</button>
                </div>
                 <p class="mt-2 text-lg">مرحباً بك <span id="studentNameDisplay" class="font-semibold"></span>!</p>
                <nav class="mt-4">
                     <ul class="flex flex-wrap gap-x-2 sm:gap-x-4 border-b border-gray-300 dark:border-gray-600 pb-1">
                        <li><button data-target="studentViewContentSection" class="student-nav-link font-semibold text-gray-600 hover:text-green-600 border-transparent hover:border-green-500">عرض المحتوى</button></li>
                        <li><button data-target="studentTakeExamSection" class="student-nav-link font-semibold text-gray-600 hover:text-green-600 border-transparent hover:border-green-500">الاختبارات المتاحة</button></li>
                    </ul>
                </nav>
            </header>

            <div id="studentViewContentSection" class="student-section bg-white p-6 rounded-lg shadow-lg">
                <h2 class="text-2xl font-semibold mb-6 text-green-700">المحتوى التعليمي</h2>
                <div id="studentContentList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    </div>
            </div>

            <div id="studentTakeExamSection" class="student-section hidden bg-white p-6 rounded-lg shadow-lg">
                <h2 class="text-2xl font-semibold mb-6 text-green-700">الاختبارات المتاحة</h2>
                <div id="studentExamsList" class="space-y-4">
                    </div>
            </div>
             <div id="studentExamViewModal" class="modal hidden">
                <div class="modal-content bg-white p-6 rounded-lg shadow-xl w-full max-w-2xl">
                    <h3 id="studentExamTitle" class="text-xl font-bold mb-4">عنوان الاختبار</h3>
                    <div id="studentExamQuestionsContainer" class="max-h-[60vh] overflow-y-auto pr-2"></div>
                    <div class="mt-6 flex justify-end gap-3">
                        <button id="closeStudentExamModalBtn" class="btn btn-secondary">إغلاق</button>
                        <button id="submitStudentExamBtn" class="btn btn-success">إرسال الإجابات</button>
                    </div>
                </div>
            </div>
        </div>
    </div> 
    
    <div id="studentModal" class="modal hidden">
        <div class="modal-content bg-white p-8 rounded-lg shadow-xl">
            <h3 id="studentModalTitle" class="text-xl font-bold mb-6">إضافة طالب جديد</h3>
            <form id="studentForm">
                <input type="hidden" id="studentId">
                <div class="mb-4">
                    <label for="studentName" class="block text-sm font-medium text-gray-700 mb-1">اسم الطالب</label>
                    <input type="text" id="studentName" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="mb-4">
                    <label for="studentUsername" class="block text-sm font-medium text-gray-700 mb-1">اسم المستخدم (للدخول)</label>
                    <input type="text" id="studentUsername" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="mb-6">
                    <label for="studentPassword" class="block text-sm font-medium text-gray-700 mb-1">كلمة المرور</label>
                    <input type="password" id="studentPassword" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="flex justify-end space-x-3 space-x-reverse">
                    <button type="button" id="cancelStudentModalBtn" class="btn btn-secondary">إلغاء</button>
                    <button type="submit" class="btn btn-primary">حفظ</button>
                </div>
            </form>
        </div>
    </div>

    <div id="contentModal" class="modal hidden">
        <div class="modal-content bg-white p-8 rounded-lg shadow-xl">
            <h3 id="contentModalTitle" class="text-xl font-bold mb-6">إضافة محتوى جديد</h3>
            <form id="contentForm">
                <input type="hidden" id="contentId">
                <div class="mb-4">
                    <label for="contentTitle" class="block text-sm font-medium text-gray-700 mb-1">عنوان المحتوى</label>
                    <input type="text" id="contentTitle" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="mb-4">
                    <label for="contentType" class="block text-sm font-medium text-gray-700 mb-1">نوع المحتوى</label>
                    <select id="contentType" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        <option value="pdf">ملف PDF</option>
                        <option value="word">ملف Word</option>
                        <option value="video">فيديو</option>
                        <option value="audio">مقطع صوتي</option>
                    </select>
                </div>
                <div class="mb-6">
                    <label for="contentLink" class="block text-sm font-medium text-gray-700 mb-1">رابط المحتوى/الملف (أو اسم الملف)</label>
                    <input type="text" id="contentLink" placeholder="مثال: https://example.com/file.pdf أو lesson1.pdf" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    <p class="text-xs text-gray-500 mt-1">ملاحظة: للتشغيل الفعلي، يجب رفع الملفات لخادم واستخدام روابط مباشرة.</p>
                </div>
                <div class="flex justify-end space-x-3 space-x-reverse">
                    <button type="button" id="cancelContentModalBtn" class="btn btn-secondary">إلغاء</button>
                    <button type="submit" class="btn btn-primary">حفظ</button>
                </div>
            </form>
        </div>
    </div>

    <div id="examModal" class="modal hidden">
        <div class="modal-content bg-white p-8 rounded-lg shadow-xl w-full max-w-2xl">
            <h3 id="examModalTitle" class="text-xl font-bold mb-6">إنشاء اختبار جديد</h3>
            <form id="examForm">
                <input type="hidden" id="examId">
                <div class="mb-4">
                    <label for="examTitle" class="block text-sm font-medium text-gray-700 mb-1">عنوان الاختبار</label>
                    <input type="text" id="examTitle" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
                
                <div id="questionsContainer" class="space-y-6 mb-6 max-h-96 overflow-y-auto p-2 border rounded-md">
                    </div>

                <button type="button" id="addQuestionBtn" class="mb-4 btn btn-warning">إضافة سؤال</button>

                <div class="flex justify-end space-x-3 space-x-reverse mt-6">
                    <button type="button" id="cancelExamModalBtn" class="btn btn-secondary">إلغاء</button>
                    <button type="submit" class="btn btn-primary">حفظ الاختبار</button>
                </div>
            </form>
        </div>
    </div>

    <div id="customAlertModal" class="modal hidden">
        <div class="modal-content bg-white p-6 rounded-lg shadow-xl w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h4 id="customAlertTitle" class="text-xl font-bold">رسالة</h4>
                <button id="customAlertCloseBtn" class="text-gray-400 hover:text-gray-600 dark:text-gray-300 dark:hover:text-gray-100 p-1 rounded-full transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <p id="customAlertMessage" class="text-gray-700 dark:text-gray-300 mb-6 break-words">محتوى الرسالة هنا.</p>
            <div id="customAlertActions" class="flex justify-end space-x-3 space-x-reverse">
                </div>
        </div>
    </div>


    <div id="chatbotIcon" class="chatbot-icon">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M8.625 12a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0H8.25m4.125 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0H12m4.125 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0h-.375M21 12c0 4.556-3.861 8.25-8.625 8.25S3.75 16.556 3.75 12C3.75 7.444 7.611 3.75 12.375 3.75S21 7.444 21 12Z" />
        </svg>
    </div>
    <div id="chatbotWindow" class="chatbot-window hidden">
        <div class="chatbot-header">Mohamed Darwish Chatbot</div>
        <div id="chatbotMessages" class="chatbot-messages">
             </div>
        <form id="chatbotInputForm" class="chatbot-input">
            <input type="text" id="chatbotUserInput" placeholder="اكتب سؤالك هنا..." class="w-full">
            <button type="submit" class="btn btn-primary" style="border-radius: 20px; padding: 10px 15px;">إرسال</button>
        </form>
    </div>


    <script>
        // --- Global State & Configuration ---
        const ADMIN_USERNAME = "MD@2510";
        const ADMIN_PASSWORD = "MD@2510";
        const DEFAULT_PROFILE_PIC = "https://placehold.co/120x120/E5E7EB/4B5563?text=صورتي";
        let appState = {
            currentUser: null,
            students: JSON.parse(localStorage.getItem('students')) || [],
            content: JSON.parse(localStorage.getItem('content')) || [],
            exams: JSON.parse(localStorage.getItem('exams')) || [],
            darkMode: localStorage.getItem('darkMode') === 'true',
            profilePic: localStorage.getItem('profilePic') || DEFAULT_PROFILE_PIC
        };

        // --- DOM Elements ---
        const appContainer = document.getElementById('appContainer');
        const loginPage = document.getElementById('loginPage');
        const registrationPage = document.getElementById('registrationPage');
        const adminDashboardPage = document.getElementById('adminDashboardPage');
        const studentDashboardPage = document.getElementById('studentDashboardPage');
        const allPages = [loginPage, registrationPage, adminDashboardPage, studentDashboardPage];

        const loginForm = document.getElementById('loginForm');
        const registrationForm = document.getElementById('registrationForm');
        const loginError = document.getElementById('loginError');
        const registerError = document.getElementById('registerError');
        const darkModeToggle = document.getElementById('darkModeToggle');
        
        const profilePicContainer = document.getElementById('profilePicContainer');
        const profileImagePreview = document.getElementById('profileImagePreview');
        const profileImageInput = document.getElementById('profileImageInput');
        const editProfilePicBtn = document.getElementById('editProfilePicBtn');
        const deleteProfilePicBtn = document.getElementById('deleteProfilePicBtn');

        const adminNavLinks = document.querySelectorAll('.admin-nav-link');
        const adminSections = document.querySelectorAll('.admin-section');
        const studentsTableBody = document.getElementById('studentsTableBody');
        const showAddStudentModalBtn = document.getElementById('showAddStudentModalBtn');
        const studentModal = document.getElementById('studentModal');
        const studentModalTitle = document.getElementById('studentModalTitle');
        const studentForm = document.getElementById('studentForm');
        const cancelStudentModalBtn = document.getElementById('cancelStudentModalBtn');
        const studentIdInput = document.getElementById('studentId');
        const studentNameInput = document.getElementById('studentName');
        const studentUsernameInput = document.getElementById('studentUsername');
        const studentPasswordInput = document.getElementById('studentPassword');
        const adminLogoutBtn = document.getElementById('adminLogoutBtn');

        const showAddContentModalBtn = document.getElementById('showAddContentModalBtn');
        const contentModal = document.getElementById('contentModal');
        const contentModalTitle = document.getElementById('contentModalTitle');
        const contentForm = document.getElementById('contentForm');
        const cancelContentModalBtn = document.getElementById('cancelContentModalBtn');
        const contentIdInput = document.getElementById('contentId');
        const contentTitleInput = document.getElementById('contentTitle');
        const contentTypeInput = document.getElementById('contentType');
        const contentLinkInput = document.getElementById('contentLink');
        const contentListDiv = document.getElementById('contentList');

        const showCreateExamModalBtn = document.getElementById('showCreateExamModalBtn');
        const examModal = document.getElementById('examModal');
        const examModalTitle = document.getElementById('examModalTitle');
        const examForm = document.getElementById('examForm');
        const cancelExamModalBtn = document.getElementById('cancelExamModalBtn');
        const examIdInput = document.getElementById('examId');
        const examTitleInput = document.getElementById('examTitle');
        const questionsContainer = document.getElementById('questionsContainer');
        const addQuestionBtn = document.getElementById('addQuestionBtn');
        const examsListDiv = document.getElementById('examsList');

        const studentNavLinks = document.querySelectorAll('.student-nav-link');
        const studentSections = document.querySelectorAll('.student-section');
        const studentLogoutBtn = document.getElementById('studentLogoutBtn');
        const studentNameDisplay = document.getElementById('studentNameDisplay');
        const studentContentListDiv = document.getElementById('studentContentList');
        const studentExamsListDiv = document.getElementById('studentExamsList');
        const studentExamViewModal = document.getElementById('studentExamViewModal');
        const studentExamTitle = document.getElementById('studentExamTitle');
        const studentExamQuestionsContainer = document.getElementById('studentExamQuestionsContainer');
        const submitStudentExamBtn = document.getElementById('submitStudentExamBtn');
        const closeStudentExamModalBtn = document.getElementById('closeStudentExamModalBtn');
        let currentStudentExamId = null;

        const chatbotIcon = document.getElementById('chatbotIcon');
        const chatbotWindow = document.getElementById('chatbotWindow');
        const chatbotMessagesDiv = document.getElementById('chatbotMessages');
        const chatbotInputForm = document.getElementById('chatbotInputForm');
        const chatbotUserInput = document.getElementById('chatbotUserInput');

        // Custom Alert/Confirm Elements
        const customAlertModal = document.getElementById('customAlertModal');
        const customAlertTitle = document.getElementById('customAlertTitle');
        const customAlertMessage = document.getElementById('customAlertMessage');
        const customAlertActions = document.getElementById('customAlertActions');
        const customAlertCloseBtn = document.getElementById('customAlertCloseBtn');
        let confirmGlobalCallback = null;
        let cancelGlobalCallback = null;

        // --- Utility Functions ---
        function navigateTo(pageId) {
            allPages.forEach(page => {
                if (page.id === pageId) {
                    page.classList.remove('hidden');
                } else {
                    page.classList.add('hidden');
                }
            });
        }

        function saveState() {
            localStorage.setItem('students', JSON.stringify(appState.students));
            localStorage.setItem('content', JSON.stringify(appState.content));
            localStorage.setItem('exams', JSON.stringify(appState.exams));
            localStorage.setItem('darkMode', appState.darkMode);
            localStorage.setItem('profilePic', appState.profilePic);
        }
        
        // --- Custom Alert/Confirm System ---
        function showCustomAlert(message, title = "تنبيه", type = "info") {
            customAlertTitle.textContent = title;
            customAlertMessage.innerHTML = message; // Use innerHTML for <br> tags

            customAlertActions.innerHTML = ''; // Clear previous buttons
            const okButton = document.createElement('button');
            okButton.textContent = "موافق";
            okButton.className = "btn btn-primary";
            okButton.onclick = () => {
                customAlertModal.classList.add('hidden');
            };
            customAlertActions.appendChild(okButton);

            customAlertTitle.className = "text-xl font-bold"; // Reset
            switch (type) {
                case 'error':
                    customAlertTitle.classList.add('text-red-600', 'dark:text-red-400');
                    break;
                case 'success':
                    customAlertTitle.classList.add('text-green-600', 'dark:text-green-400');
                    break;
                case 'warning':
                    customAlertTitle.classList.add('text-yellow-500', 'dark:text-yellow-400');
                    break;
                default: // info
                    customAlertTitle.classList.add('text-blue-600', 'dark:text-blue-400');
                    break;
            }
            customAlertModal.classList.remove('hidden');
        }

        function showCustomConfirm(message, title = "تأكيد", onConfirm, onCancel) {
            customAlertTitle.textContent = title;
            customAlertMessage.innerHTML = message;
            confirmGlobalCallback = onConfirm;
            cancelGlobalCallback = onCancel;

            customAlertActions.innerHTML = '';
            const confirmButton = document.createElement('button');
            confirmButton.textContent = "تأكيد";
            confirmButton.className = "btn btn-success"; // Or btn-danger if it's a destructive action
            confirmButton.onclick = () => {
                customAlertModal.classList.add('hidden');
                if (confirmGlobalCallback) confirmGlobalCallback();
                confirmGlobalCallback = null; cancelGlobalCallback = null;
            };

            const cancelButton = document.createElement('button');
            cancelButton.textContent = "إلغاء";
            cancelButton.className = "btn btn-secondary";
            cancelButton.onclick = () => {
                customAlertModal.classList.add('hidden');
                if (cancelGlobalCallback) cancelGlobalCallback();
                confirmGlobalCallback = null; cancelGlobalCallback = null;
            };
            customAlertActions.appendChild(cancelButton); 
            customAlertActions.appendChild(confirmButton);

            customAlertTitle.className = "text-xl font-bold text-yellow-600 dark:text-yellow-400";
            customAlertModal.classList.remove('hidden');
        }

        customAlertCloseBtn.addEventListener('click', () => {
            customAlertModal.classList.add('hidden');
            if (cancelGlobalCallback && customAlertActions.querySelector('.btn-secondary')) { 
                cancelGlobalCallback();
            }
            confirmGlobalCallback = null; 
            cancelGlobalCallback = null;
        });
        
        // Close modals with Escape key
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                [studentModal, contentModal, examModal, studentExamViewModal, customAlertModal].forEach(modal => {
                    if (!modal.classList.contains('hidden')) {
                        // For confirm modal, pressing Esc should be like Cancel
                        if (modal === customAlertModal && cancelGlobalCallback && customAlertActions.querySelector('.btn-secondary')) {
                             cancelGlobalCallback();
                        }
                        modal.classList.add('hidden');
                        confirmGlobalCallback = null; 
                        cancelGlobalCallback = null;
                    }
                });
                 if (!chatbotWindow.classList.contains('hidden')) {
                    chatbotWindow.classList.add('hidden');
                }
            }
        });


        function applyDarkMode() {
            const htmlElement = document.documentElement;
            if (appState.darkMode) {
                htmlElement.classList.add('dark');
                darkModeToggle.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-full h-full">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386-1.591 1.591M21 12h-2.25m-.386 6.364-1.591-1.591M12 18.75V21m-4.773-4.227-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0Z" />
                    </svg>`; // Sun icon
            } else {
                htmlElement.classList.remove('dark');
                darkModeToggle.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-full h-full">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.72 9.72 0 0 1 18 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 0 0 3 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 0 0 9.002-5.998Z" />
                    </svg>`; // Moon icon
            }
        }
        
        // --- Profile Picture Logic ---
        function loadProfilePic() {
            profileImagePreview.src = appState.profilePic;
            if (appState.profilePic && appState.profilePic !== DEFAULT_PROFILE_PIC) {
                deleteProfilePicBtn.classList.remove('hidden');
            } else {
                deleteProfilePicBtn.classList.add('hidden');
            }
        }

        editProfilePicBtn.addEventListener('click', () => profileImageInput.click());
        profilePicContainer.addEventListener('click', (e) => {
            if (e.target !== deleteProfilePicBtn && !deleteProfilePicBtn.contains(e.target) && e.target !== editProfilePicBtn && !editProfilePicBtn.contains(e.target)) {
                 profileImageInput.click();
            }
        });

        profileImageInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    appState.profilePic = e.target.result;
                    profileImagePreview.src = appState.profilePic;
                    deleteProfilePicBtn.classList.remove('hidden');
                    saveState();
                }
                reader.readAsDataURL(file);
            }
        });

        deleteProfilePicBtn.addEventListener('click', (e) => {
            e.stopPropagation(); 
            showCustomConfirm('هل أنت متأكد من حذف الصورة الشخصية؟', 'تأكيد الحذف', () => {
                appState.profilePic = DEFAULT_PROFILE_PIC;
                profileImagePreview.src = appState.profilePic;
                deleteProfilePicBtn.classList.add('hidden');
                profileImageInput.value = ''; 
                saveState();
            });
        });

        // --- Authentication ---
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const username = loginForm.username.value;
            const password = loginForm.password.value;
            loginError.textContent = '';

            if (username === ADMIN_USERNAME && password === ADMIN_PASSWORD) {
                appState.currentUser = { username: ADMIN_USERNAME, role: 'admin' };
                navigateTo('adminDashboardPage');
                renderAdminDashboard();
            } else {
                const student = appState.students.find(s => s.username === username && s.password === password);
                if (student) {
                    appState.currentUser = { username: student.username, name: student.name, role: 'student' };
                    navigateTo('studentDashboardPage');
                    renderStudentDashboard();
                } else {
                    loginError.textContent = 'اسم المستخدم أو كلمة المرور غير صحيحة.';
                }
            }
        });

        registrationForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const name = registrationForm.regName.value;
            const username = registrationForm.regUsername.value;
            const password = registrationForm.regPassword.value;
            registerError.textContent = '';

            if (appState.students.find(s => s.username === username)) {
                registerError.textContent = 'اسم المستخدم هذا موجود بالفعل.';
                return;
            }
            if (username === ADMIN_USERNAME) {
                 registerError.textContent = 'لا يمكن استخدام اسم مستخدم المدير.';
                return;
            }

            const newStudent = { id: Date.now().toString(), name, username, password };
            appState.students.push(newStudent);
            saveState();
            showCustomAlert('تم التسجيل بنجاح! يمكنك الآن تسجيل الدخول.', 'نجاح التسجيل', 'success');
            navigateTo('loginPage');
            registrationForm.reset();
        });
        
        document.getElementById('showRegisterLink').addEventListener('click', (e) => {
            e.preventDefault();
            navigateTo('registrationPage');
        });
        document.getElementById('showLoginLinkFromRegister').addEventListener('click', (e) => {
            e.preventDefault();
            navigateTo('loginPage');
        });

        function logout() {
            appState.currentUser = null;
            navigateTo('loginPage');
        }
        adminLogoutBtn.addEventListener('click', logout);
        studentLogoutBtn.addEventListener('click', logout);

        // --- Dark Mode ---
        darkModeToggle.addEventListener('click', () => {
            appState.darkMode = !appState.darkMode;
            applyDarkMode();
            saveState();
        });

        // --- Admin Dashboard Logic ---
        function renderAdminDashboard() {
            switchAdminSection('adminStudentsSection');
            renderStudentsTable();
            renderContentList();
            renderExamsList();
        }

        adminNavLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                switchAdminSection(e.target.dataset.target);
            });
        });

        function switchAdminSection(sectionId) {
            adminSections.forEach(section => {
                if (section.id === sectionId) section.classList.remove('hidden');
                else section.classList.add('hidden');
            });
            adminNavLinks.forEach(link => {
                link.classList.remove('admin-nav-active');
                if (link.dataset.target === sectionId) {
                    link.classList.add('admin-nav-active');
                }
            });
        }

        function renderStudentsTable() {
            studentsTableBody.innerHTML = '';
            if (appState.students.length === 0) {
                studentsTableBody.innerHTML = '<tr><td colspan="3" class="text-center py-4">لا يوجد طلاب مسجلون حالياً.</td></tr>';
                return;
            }
            appState.students.forEach(student => {
                const row = studentsTableBody.insertRow();
                row.className = "hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors";
                row.innerHTML = `
                    <td class="py-3 px-4 border-b dark:border-gray-600">${student.name}</td>
                    <td class="py-3 px-4 border-b dark:border-gray-600">${student.username}</td>
                    <td class="py-3 px-4 border-b dark:border-gray-600">
                        <button onclick="editStudent('${student.id}')" class="btn-action-table edit">تعديل</button>
                        <button onclick="deleteStudent('${student.id}')" class="btn-action-table delete">حذف</button>
                    </td>
                `;
            });
        }

        showAddStudentModalBtn.addEventListener('click', () => {
            studentModalTitle.textContent = 'إضافة طالب جديد';
            studentForm.reset();
            studentIdInput.value = '';
            studentModal.classList.remove('hidden');
        });

        cancelStudentModalBtn.addEventListener('click', () => {
            studentModal.classList.add('hidden');
        });

        studentForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const id = studentIdInput.value;
            const name = studentNameInput.value;
            const username = studentUsernameInput.value;
            const password = studentPasswordInput.value;

            if (id) { 
                const studentIndex = appState.students.findIndex(s => s.id === id);
                if (studentIndex > -1) {
                    // Check if new username already exists (excluding current student)
                    if (appState.students.some(s => s.username === username && s.id !== id)) {
                        showCustomAlert('اسم المستخدم هذا موجود بالفعل لطالب آخر.', 'خطأ', 'error');
                        return;
                    }
                    appState.students[studentIndex] = { ...appState.students[studentIndex], name, username, password };
                }
            } else { 
                 if (appState.students.find(s => s.username === username)) {
                    showCustomAlert('اسم المستخدم هذا موجود بالفعل.', 'خطأ', 'error');
                    return;
                }
                appState.students.push({ id: Date.now().toString(), name, username, password });
            }
            saveState();
            renderStudentsTable();
            studentModal.classList.add('hidden');
            showCustomAlert(id ? 'تم تحديث بيانات الطالب بنجاح.' : 'تم إضافة الطالب بنجاح.', 'نجاح', 'success');
        });

        window.editStudent = (id) => { 
            const student = appState.students.find(s => s.id === id);
            if (student) {
                studentModalTitle.textContent = 'تعديل بيانات الطالب';
                studentIdInput.value = student.id;
                studentNameInput.value = student.name;
                studentUsernameInput.value = student.username;
                studentPasswordInput.value = student.password; 
                studentModal.classList.remove('hidden');
            }
        };

        window.deleteStudent = (id) => { 
            showCustomConfirm('هل أنت متأكد من حذف هذا الطالب؟', 'تأكيد الحذف', () => {
                appState.students = appState.students.filter(s => s.id !== id);
                saveState();
                renderStudentsTable();
                showCustomAlert('تم حذف الطالب بنجاح.', 'نجاح', 'success');
            });
        };

        function renderContentList() {
            contentListDiv.innerHTML = '';
             if (appState.content.length === 0) {
                contentListDiv.innerHTML = '<p class="text-center col-span-full py-4 text-gray-500">لا يوجد محتوى مضاف حالياً.</p>';
                return;
            }
            appState.content.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'bg-gray-50 dark:bg-gray-800 p-4 rounded-lg shadow hover:shadow-xl transition-shadow flex flex-col justify-between';
                let icon = '';
                switch(item.type) {
                    case 'pdf': icon = '📄'; break;
                    case 'word': icon = '📝'; break;
                    case 'video': icon = '🎬'; break;
                    case 'audio': icon = '🎧'; break;
                }
                itemDiv.innerHTML = `
                    <div>
                        <h4 class="text-lg font-semibold text-blue-600 dark:text-blue-400 mb-1">${icon} ${item.title}</h4>
                        <p class="text-sm text-gray-500 dark:text-gray-400 mb-2">النوع: ${item.type.toUpperCase()}</p>
                        <p class="text-xs text-gray-400 dark:text-gray-500 truncate" title="${item.link}">الرابط: ${item.link}</p>
                    </div>
                    <div class="mt-4 flex gap-2 justify-end">
                        <button onclick="editContent('${item.id}')" class="btn-action-table edit">تعديل</button>
                        <button onclick="deleteContent('${item.id}')" class="btn-action-table delete">حذف</button>
                    </div>
                `;
                contentListDiv.appendChild(itemDiv);
            });
        }
        
        showAddContentModalBtn.addEventListener('click', () => {
            contentModalTitle.textContent = 'إضافة محتوى جديد';
            contentForm.reset();
            contentIdInput.value = '';
            contentModal.classList.remove('hidden');
        });

        cancelContentModalBtn.addEventListener('click', () => {
            contentModal.classList.add('hidden');
        });

        contentForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const id = contentIdInput.value;
            const title = contentTitleInput.value;
            const type = contentTypeInput.value;
            const link = contentLinkInput.value;

            if (id) {
                const index = appState.content.findIndex(c => c.id === id);
                if (index > -1) appState.content[index] = { ...appState.content[index], title, type, link };
            } else {
                appState.content.push({ id: Date.now().toString(), title, type, link });
            }
            saveState();
            renderContentList();
            renderStudentContentList(); 
            contentModal.classList.add('hidden');
            showCustomAlert(id ? 'تم تحديث المحتوى بنجاح.' : 'تم إضافة المحتوى بنجاح.', 'نجاح', 'success');
        });

        window.editContent = (id) => {
            const item = appState.content.find(c => c.id === id);
            if (item) {
                contentModalTitle.textContent = 'تعديل المحتوى';
                contentIdInput.value = item.id;
                contentTitleInput.value = item.title;
                contentTypeInput.value = item.type;
                contentLinkInput.value = item.link;
                contentModal.classList.remove('hidden');
            }
        };

        window.deleteContent = (id) => {
            showCustomConfirm('هل أنت متأكد من حذف هذا المحتوى؟', 'تأكيد الحذف', () => {
                appState.content = appState.content.filter(c => c.id !== id);
                saveState();
                renderContentList();
                renderStudentContentList();
                showCustomAlert('تم حذف المحتوى بنجاح.', 'نجاح', 'success');
            });
        };

        let currentQuestions = []; 

        function renderExamsList() {
            examsListDiv.innerHTML = '';
            if (appState.exams.length === 0) {
                examsListDiv.innerHTML = '<p class="text-center py-4 text-gray-500">لا يوجد اختبارات منشأة حالياً.</p>';
                return;
            }
            appState.exams.forEach(exam => {
                const examCard = document.createElement('div');
                examCard.className = 'bg-gray-50 dark:bg-gray-800 p-4 rounded-lg shadow hover:shadow-xl transition-shadow';
                examCard.innerHTML = `
                    <h4 class="text-lg font-semibold text-purple-600 dark:text-purple-400">${exam.title}</h4>
                    <p class="text-sm text-gray-500 dark:text-gray-400">عدد الأسئلة: ${exam.questions.length}</p>
                    <div class="mt-4 flex flex-wrap gap-2 justify-end">
                        <button onclick="editExam('${exam.id}')" class="btn-action-table edit">تعديل</button>
                        <button onclick="deleteExam('${exam.id}')" class="btn-action-table delete">حذف</button>
                        <button onclick="previewExam('${exam.id}')" class="btn-action-table preview">معاينة</button>
                    </div>
                `;
                examsListDiv.appendChild(examCard);
            });
        }

        showCreateExamModalBtn.addEventListener('click', () => {
            examModalTitle.textContent = 'إنشاء اختبار جديد';
            examForm.reset();
            examIdInput.value = '';
            currentQuestions = [];
            renderQuestionsInModal();
            examModal.classList.remove('hidden');
        });
        
        cancelExamModalBtn.addEventListener('click', () => {
            examModal.classList.add('hidden');
        });

        addQuestionBtn.addEventListener('click', () => {
            const questionType = prompt("نوع السؤال:\n1. اختيار من متعدد (اكتب mcq)\n2. مقالي (اكتب essay)", "mcq");
            if (!questionType || (questionType.toLowerCase() !== 'mcq' && questionType.toLowerCase() !== 'essay')) return;

            const questionText = prompt("نص السؤال:");
            if (!questionText) return;

            let questionData = { id: Date.now().toString(), type: questionType.toLowerCase(), text: questionText };

            if (questionData.type === 'mcq') {
                questionData.options = [];
                let option;
                for (let i = 0; i < 4; i++) { 
                    option = prompt(`خيار ${i + 1}: (اترك فارغاً واضغط موافق لإنهاء إضافة الخيارات)`);
                    if (option === null) { // User pressed cancel
                        if (i<2) {
                            showCustomAlert("يجب إدخال خيارين على الأقل لسؤال الاختيار من متعدد.", 'خطأ في الإدخال', 'error');
                            return;
                        }
                        break;
                    }
                    if (option.trim() === "" && i >= 2) break; // Allow less than 4 options if user leaves empty and presses OK (after 2 options)
                     if (option.trim() === "" && i < 2) {
                         showCustomAlert(`الخيار ${i+1} لا يمكن أن يكون فارغاً.`, 'خطأ في الإدخال', 'error');
                         return;
                     }
                    questionData.options.push(option);
                }
                if (questionData.options.length < 2) {
                     showCustomAlert("يجب إدخال خيارين على الأقل لسؤال الاختيار من متعدد.", 'خطأ في الإدخال', 'error');
                     return;
                }
                let correctOptionIndexStr;
                let correctOptionIndex;
                do {
                   correctOptionIndexStr = prompt(`رقم الخيار الصحيح (1-${questionData.options.length}):`, "1");
                   if(correctOptionIndexStr === null) return; // User cancelled
                   correctOptionIndex = parseInt(correctOptionIndexStr) - 1;
                } while (isNaN(correctOptionIndex) || correctOptionIndex < 0 || correctOptionIndex >= questionData.options.length);
                questionData.correctAnswer = correctOptionIndex;
            }
            currentQuestions.push(questionData);
            renderQuestionsInModal();
        });

        function renderQuestionsInModal() {
            questionsContainer.innerHTML = '';
            if (currentQuestions.length === 0) {
                 questionsContainer.innerHTML = '<p class="text-sm text-gray-500 text-center py-3">لم تتم إضافة أسئلة بعد.</p>';
                 return;
            }
            currentQuestions.forEach((q, index) => {
                const qDiv = document.createElement('div');
                qDiv.className = 'p-3 border rounded-md bg-gray-50 dark:bg-gray-700 shadow-sm';
                let optionsHTML = '';
                if (q.type === 'mcq') {
                    optionsHTML = '<ul class="list-decimal list-inside mr-5 mt-2 text-sm space-y-1">';
                    q.options.forEach((opt, i) => {
                        optionsHTML += `<li class="${i === q.correctAnswer ? 'font-semibold text-green-700 dark:text-green-400' : 'text-gray-700 dark:text-gray-300'}">${opt}</li>`;
                    });
                    optionsHTML += '</ul>';
                }
                qDiv.innerHTML = `
                    <div class="flex justify-between items-start">
                        <p class="font-semibold flex-1 text-gray-800 dark:text-gray-200">${index + 1}. ${q.text} <span class="text-xs text-gray-400 dark:text-gray-500">(${q.type === 'mcq' ? 'اختيار من متعدد' : 'مقالي'})</span></p>
                        <button type="button" onclick="removeQuestionFromModal('${q.id}')" class="text-red-500 hover:text-red-700 p-1 rounded-full hover:bg-red-100 dark:hover:bg-red-700 transition-all focus:outline-none">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                        </button>
                    </div>
                    ${optionsHTML}
                `;
                questionsContainer.appendChild(qDiv);
            });
        }
        
        window.removeQuestionFromModal = (questionId) => {
            currentQuestions = currentQuestions.filter(q => q.id !== questionId);
            renderQuestionsInModal();
        };

        examForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const id = examIdInput.value;
            const title = examTitleInput.value;

            if (currentQuestions.length === 0) {
                showCustomAlert('يجب إضافة سؤال واحد على الأقل للاختبار.', 'خطأ', 'error');
                return;
            }

            if (id) { 
                const index = appState.exams.findIndex(ex => ex.id === id);
                if (index > -1) appState.exams[index] = { ...appState.exams[index], title, questions: [...currentQuestions] };
            } else { 
                appState.exams.push({ id: Date.now().toString(), title, questions: [...currentQuestions] });
            }
            saveState();
            renderExamsList();
            renderStudentExamsList();
            examModal.classList.add('hidden');
            showCustomAlert(id ? 'تم تحديث الاختبار بنجاح.' : 'تم إنشاء الاختبار بنجاح.', 'نجاح', 'success');
        });

        window.editExam = (id) => {
            const exam = appState.exams.find(ex => ex.id === id);
            if (exam) {
                examModalTitle.textContent = 'تعديل الاختبار';
                examIdInput.value = exam.id;
                examTitleInput.value = exam.title;
                currentQuestions = JSON.parse(JSON.stringify(exam.questions)); 
                renderQuestionsInModal();
                examModal.classList.remove('hidden');
            }
        };
        
        window.deleteExam = (id) => {
            showCustomConfirm('هل أنت متأكد من حذف هذا الاختبار؟ سيتم حذفه أيضاً من قائمة الطلاب.', 'تأكيد الحذف', () => {
                appState.exams = appState.exams.filter(ex => ex.id !== id);
                saveState();
                renderExamsList();
                renderStudentExamsList();
                showCustomAlert('تم حذف الاختبار بنجاح.', 'نجاح', 'success');
            });
        };

        window.previewExam = (examId) => {
            const exam = appState.exams.find(ex => ex.id === examId);
            if (!exam) return;
            studentExamTitle.textContent = `معاينة: ${exam.title}`;
            studentExamQuestionsContainer.innerHTML = ''; 
            exam.questions.forEach((q, index) => {
                const qDiv = document.createElement('div');
                qDiv.className = 'mb-4 p-3 border rounded bg-gray-50 dark:bg-gray-700';
                qDiv.innerHTML = `<p class="font-semibold text-gray-800 dark:text-gray-200">${index + 1}. ${q.text}</p>`;
                if (q.type === 'mcq') {
                    const optionsDiv = document.createElement('div');
                    optionsDiv.className = 'mt-2 space-y-1';
                    q.options.forEach((opt, optIndex) => {
                        optionsDiv.innerHTML += `
                            <label class="flex items-center cursor-not-allowed text-gray-700 dark:text-gray-300">
                                <input type="radio" name="preview_question_${q.id}" value="${optIndex}" class="ml-2 form-radio text-blue-500" disabled ${optIndex === q.correctAnswer ? 'checked' : ''}>
                                <span class="${optIndex === q.correctAnswer ? 'text-green-600 dark:text-green-400 font-bold' : ''}">${opt}</span>
                            </label>
                        `;
                    });
                    qDiv.appendChild(optionsDiv);
                } else if (q.type === 'essay') {
                    qDiv.innerHTML += `<textarea name="preview_question_${q.id}" rows="3" class="w-full mt-2 p-2 border rounded bg-gray-100 dark:bg-gray-600 dark:border-gray-500" placeholder="مكان إجابة الطالب..." disabled></textarea>`;
                }
                studentExamQuestionsContainer.appendChild(qDiv);
            });
            studentExamViewModal.classList.remove('hidden');
            submitStudentExamBtn.classList.add('hidden'); 
            closeStudentExamModalBtn.textContent = "إغلاق المعاينة";
        };

        // --- Student Dashboard Logic ---
        function renderStudentDashboard() {
            if (!appState.currentUser || appState.currentUser.role !== 'student') {
                navigateTo('loginPage'); 
                return;
            }
            studentNameDisplay.textContent = appState.currentUser.name;
            switchStudentSection('studentViewContentSection');
            renderStudentContentList();
            renderStudentExamsList();
        }

        studentNavLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                switchStudentSection(e.target.dataset.target);
            });
        });

        function switchStudentSection(sectionId) {
            studentSections.forEach(section => {
                if (section.id === sectionId) section.classList.remove('hidden');
                else section.classList.add('hidden');
            });
            studentNavLinks.forEach(link => {
                link.classList.remove('student-nav-active');
                if (link.dataset.target === sectionId) {
                    link.classList.add('student-nav-active');
                }
            });
        }

        function renderStudentContentList() {
            studentContentListDiv.innerHTML = '';
            if (appState.content.length === 0) {
                studentContentListDiv.innerHTML = '<p class="text-center col-span-full py-4 text-gray-500">لا يوجد محتوى تعليمي متاح حالياً.</p>';
                return;
            }
            appState.content.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'bg-gray-50 dark:bg-gray-800 p-4 rounded-lg shadow hover:shadow-xl transition-shadow';
                let icon = '';
                switch(item.type) {
                    case 'pdf': icon = '📄'; break;
                    case 'word': icon = '📝'; break;
                    case 'video': icon = '🎬'; break;
                    case 'audio': icon = '🎧'; break;
                }
                const linkContent = item.link.startsWith('http') ? `<a href="${item.link}" target="_blank" class="text-blue-500 hover:underline break-all">${item.link}</a>` : `<span class="break-all">${item.link}</span>`;

                itemDiv.innerHTML = `
                    <h4 class="text-lg font-semibold text-green-600 dark:text-green-400 mb-1">${icon} ${item.title}</h4>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mb-2">النوع: ${item.type.toUpperCase()}</p>
                    <p class="text-xs text-gray-400 dark:text-gray-500" title="${item.link}">الرابط: ${linkContent}</p>
                `;
                studentContentListDiv.appendChild(itemDiv);
            });
        }

        function renderStudentExamsList() {
            studentExamsListDiv.innerHTML = '';
             if (appState.exams.length === 0) {
                studentExamsListDiv.innerHTML = '<p class="text-center py-4 text-gray-500">لا توجد اختبارات متاحة حالياً.</p>';
                return;
            }
            appState.exams.forEach(exam => {
                const examCard = document.createElement('div');
                examCard.className = 'bg-gray-50 dark:bg-gray-800 p-4 rounded-lg shadow hover:shadow-xl transition-shadow flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3';
                examCard.innerHTML = `
                    <div>
                        <h4 class="text-lg font-semibold text-green-600 dark:text-green-400">${exam.title}</h4>
                        <p class="text-sm text-gray-500 dark:text-gray-400">عدد الأسئلة: ${exam.questions.length}</p>
                    </div>
                    <button onclick="startStudentExam('${exam.id}')" class="btn btn-success w-full sm:w-auto mt-2 sm:mt-0">بدء الاختبار</button>
                `;
                studentExamsListDiv.appendChild(examCard);
            });
        }
        
        window.startStudentExam = (examId) => {
            const exam = appState.exams.find(ex => ex.id === examId);
            if (!exam) return;
            currentStudentExamId = examId;
            studentExamTitle.textContent = exam.title;
            studentExamQuestionsContainer.innerHTML = ''; 
            exam.questions.forEach((q, index) => {
                const qDiv = document.createElement('div');
                qDiv.className = 'mb-4 p-3 border rounded bg-gray-50 dark:bg-gray-700';
                qDiv.innerHTML = `<p class="font-semibold mb-2 text-gray-800 dark:text-gray-200">${index + 1}. ${q.text}</p>`;
                if (q.type === 'mcq') {
                    const optionsDiv = document.createElement('div');
                    optionsDiv.className = 'space-y-2';
                    q.options.forEach((opt, optIndex) => {
                        optionsDiv.innerHTML += `
                            <label class="flex items-center p-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-600 cursor-pointer transition-colors text-gray-700 dark:text-gray-300">
                                <input type="radio" name="question_${q.id}" value="${optIndex}" class="ml-3 form-radio text-blue-600 focus:ring-blue-500 dark:text-blue-400 dark:focus:ring-blue-400 dark:bg-gray-600 dark:border-gray-500">
                                <span>${opt}</span>
                            </label>
                        `;
                    });
                    qDiv.appendChild(optionsDiv);
                } else if (q.type === 'essay') {
                    qDiv.innerHTML += `<textarea name="question_${q.id}" rows="4" class="w-full mt-2 p-2 border border-gray-300 rounded-md dark:bg-gray-600 dark:border-gray-500 focus:ring-blue-500 focus:border-blue-500 text-gray-800 dark:text-gray-200" placeholder="اكتب إجابتك هنا..."></textarea>`;
                }
                studentExamQuestionsContainer.appendChild(qDiv);
            });
            studentExamViewModal.classList.remove('hidden');
            submitStudentExamBtn.classList.remove('hidden');
            submitStudentExamBtn.textContent = "إرسال الإجابات";
            closeStudentExamModalBtn.textContent = "إغلاق";
            submitStudentExamBtn.onclick = handleStudentExamSubmit; 
        };
        
        closeStudentExamModalBtn.addEventListener('click', () => {
            studentExamViewModal.classList.add('hidden');
        });

        function handleStudentExamSubmit() {
            if (!currentStudentExamId) return;
            const exam = appState.exams.find(ex => ex.id === currentStudentExamId);
            if (!exam) return;

            let score = 0;
            let totalMcq = 0;
            const studentAnswers = {};

            exam.questions.forEach(q => {
                const formElements = studentExamQuestionsContainer.querySelectorAll(`[name="question_${q.id}"]`);
                if (q.type === 'mcq') {
                    totalMcq++;
                    let answered = false;
                    formElements.forEach(input => {
                        if (input.checked) {
                            studentAnswers[q.id] = parseInt(input.value);
                            if (parseInt(input.value) === q.correctAnswer) {
                                score++;
                            }
                            answered = true;
                        }
                    });
                    if(!answered) studentAnswers[q.id] = null; // Mark as unanswered
                } else if (q.type === 'essay') {
                     if(formElements.length > 0) studentAnswers[q.id] = formElements[0].value;
                     else studentAnswers[q.id] = ""; // No answer
                }
            });
            
            let resultMessage = `لقد أكملت الاختبار "${exam.title}".<br><br>`;
            if (totalMcq > 0) {
                 resultMessage += `نتيجتك في أسئلة الاختيار من متعدد: ${score} من ${totalMcq}.<br>`;
            } else {
                resultMessage += `لا توجد أسئلة اختيار من متعدد في هذا الاختبار.<br>`;
            }
            resultMessage += "إجابات الأسئلة المقالية (إذا وجدت) تم تسجيلها وستتم مراجعتها من قبل الأستاذ إن أمكن.";
            
            showCustomAlert(resultMessage, 'نتيجة الاختبار', 'info');
            console.log(`Student ${appState.currentUser.username} Answers for exam "${exam.title}":`, studentAnswers);

            studentExamViewModal.classList.add('hidden');
            currentStudentExamId = null;
        }

        // --- Chatbot Logic ---
        const chatResponses = {
            "مرحبا": "أهلاً بك! كيف يمكنني مساعدتك اليوم؟ أنا روبوت الأستاذ محمد درويش.",
            "اهلا": "أهلاً بك! كيف يمكنني مساعدتك اليوم؟",
            "السلام عليكم": "وعليكم السلام ورحمة الله وبركاته! كيف أقدر أساعدك؟",
            "كيف حالك": "أنا بخير، شكراً لسؤالك! ماذا عنك؟",
            "ما هي المواد المتاحة": "يمكنك العثور على جميع المواد الدراسية في قسم 'عرض المحتوى' بعد تسجيل الدخول كطالب.",
            "متى الاختبار": "مواعيد الاختبارات وأسماؤها معلنة في قسم 'الاختبارات المتاحة' للطلاب المسجلين.",
            "شكرا": "على الرحب والسعة! هل هناك أي شيء آخر يمكنني المساعدة به؟",
            "مع السلامة": "إلى اللقاء! بالتوفيق في دراستك.",
            "default": "أعتذر، لم أفهم سؤالك جيداً. هل يمكنك إعادة صياغته أو طرح سؤال آخر؟ يمكنك أيضاً التواصل مع الأستاذ محمد درويش مباشرة عبر معلومات الاتصال الموجودة في ملفه الشخصي."
        };

        chatbotIcon.addEventListener('click', () => {
            const isHidden = chatbotWindow.classList.toggle('hidden');
            if (!isHidden) { 
                if(chatbotMessagesDiv.children.length === 0 || 
                   (chatbotMessagesDiv.children.length === 1 && chatbotMessagesDiv.lastChild.classList.contains('bot-message') && chatbotMessagesDiv.lastChild.textContent.includes("أهلاً بك! أنا مساعدك الآلي"))) {
                    if(chatbotMessagesDiv.children.length === 1 && chatbotMessagesDiv.lastChild.textContent.includes("أهلاً بك! أنا مساعدك الآلي")) {
                        chatbotMessagesDiv.innerHTML = '';
                    }
                    addMessageToChatbot("أهلاً بك! أنا مساعدك الآلي للأستاذ محمد درويش. كيف يمكنني خدمتك؟", 'bot');
                }
                chatbotUserInput.focus();
            }
        });

        chatbotInputForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const userInput = chatbotUserInput.value.trim();
            if (userInput === '') return;

            addMessageToChatbot(userInput, 'user');
            chatbotUserInput.value = '';

            setTimeout(() => {
                let botResponse = chatResponses['default'];
                let bestMatchLength = 0;
                for (const keyword in chatResponses) {
                    if (userInput.toLowerCase().includes(keyword.toLowerCase())) {
                        if (keyword.length > bestMatchLength) {
                           botResponse = chatResponses[keyword];
                           bestMatchLength = keyword.length;
                        }
                    }
                }
                addMessageToChatbot(botResponse, 'bot');
            }, 600);
        });

        function addMessageToChatbot(text, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', sender === 'user' ? 'user-message' : 'bot-message');
            messageDiv.textContent = text;
            messageDiv.classList.add('message-enter'); // Animation class
            chatbotMessagesDiv.appendChild(messageDiv);
            chatbotMessagesDiv.scrollTop = chatbotMessagesDiv.scrollHeight; 
        }

        // --- Initialization ---
        function initializeApp() {
            applyDarkMode(); 
            loadProfilePic(); 
            navigateTo('loginPage');
        }

        initializeApp();
    </script>
</body>
</html>

